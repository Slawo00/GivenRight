<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Aegis Voice Chat - Google Meet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.3em;
            opacity: 0.8;
            margin-bottom: 40px;
        }
        
        .status {
            font-size: 1.5em;
            margin-bottom: 30px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .talk-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border: none;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            color: white;
            font-size: 2.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
        }
        
        .talk-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(78, 205, 196, 0.6);
        }
        
        .talk-btn.recording {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .text-input-section {
            margin: 30px 0;
        }
        
        .text-input {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            margin-bottom: 15px;
        }
        
        .send-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .conversation {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            text-align: left;
        }
        
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 15px;
            font-size: 1em;
            line-height: 1.5;
        }
        
        .user-message {
            background: rgba(255, 255, 255, 0.2);
            margin-left: 50px;
            border-bottom-right-radius: 5px;
        }
        
        .ai-message {
            background: rgba(255, 255, 255, 0.1);
            margin-right: 50px;
            border-bottom-left-radius: 5px;
        }
        
        .speaker-label {
            font-weight: bold;
            margin-bottom: 8px;
            opacity: 0.8;
            font-size: 0.9em;
        }
        
        .audio-player {
            margin-top: 10px;
        }
        
        audio {
            width: 100%;
            opacity: 0.8;
        }
        
        .instructions {
            margin-top: 30px;
            font-size: 0.95em;
            opacity: 0.7;
            line-height: 1.6;
        }
        
        .instructions strong {
            color: #4ecdc4;
        }
        
        .error {
            background: rgba(255, 107, 107, 0.3);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Aegis</h1>
        <div class="subtitle">Google Meet Voice Chat</div>
        
        <div class="status" id="status">
            Bereit f√ºr nat√ºrliche Unterhaltung
        </div>
        
        <div class="controls">
            <button class="talk-btn" id="talkBtn" title="Sprechen">üé§</button>
        </div>
        
        <div class="text-input-section">
            <input type="text" class="text-input" id="textInput" placeholder="Oder schreibe eine Nachricht...">
            <button class="send-btn" id="sendBtn">Senden</button>
        </div>
        
        <div class="conversation" id="conversation">
            <div class="message ai-message">
                <div class="speaker-label">üõ°Ô∏è Aegis:</div>
                Hallo Ironman! Perfekt - jetzt k√∂nnen wir √ºber Google Meet fl√ºssig sprechen. 
                Klicke auf das Mikrofon oder schreibe eine Nachricht!
            </div>
        </div>
        
        <div class="instructions">
            <strong>So funktioniert es:</strong><br>
            ‚Ä¢ üé§ <strong>Sprechen:</strong> Mikrofon klicken ‚Üí sprechen ‚Üí ich antworte mit Audio<br>
            ‚Ä¢ ‚å®Ô∏è <strong>Schreiben:</strong> Text eingeben ‚Üí ich antworte mit Audio<br>
            ‚Ä¢ üì∫ <strong>Share Screen in Google Meet</strong> damit du mich h√∂rst!
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const talkBtn = document.getElementById('talkBtn');
        const status = document.getElementById('status');
        const conversation = document.getElementById('conversation');
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        
        let mediaRecorder;
        let isRecording = false;
        
        // Voice recording
        talkBtn.addEventListener('click', toggleRecording);
        
        // Text input
        sendBtn.addEventListener('click', sendTextMessage);
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendTextMessage();
        });
        
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks);
                    const base64 = await blobToBase64(audioBlob);
                    socket.emit('user-speech', base64);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                talkBtn.classList.add('recording');
                status.textContent = 'üé§ Spreche jetzt...';
                
            } catch (error) {
                showError('Mikrofon-Zugriff verweigert: ' + error.message);
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                talkBtn.classList.remove('recording');
                status.textContent = 'Verarbeite Sprache...';
            }
        }
        
        function sendTextMessage() {
            const text = textInput.value.trim();
            if (text) {
                socket.emit('text-input', text);
                textInput.value = '';
                status.textContent = 'Denke nach...';
            }
        }
        
        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.readAsDataURL(blob);
            });
        }
        
        function addMessage(type, text, audioData = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}-message`;
            
            const label = type === 'user' ? 'üë§ Du' : 'üõ°Ô∏è Aegis';
            msgDiv.innerHTML = `
                <div class="speaker-label">${label}:</div>
                ${text}
            `;
            
            if (audioData && type === 'ai') {
                const audioPlayer = document.createElement('div');
                audioPlayer.className = 'audio-player';
                audioPlayer.innerHTML = `
                    <audio controls autoplay>
                        <source src="data:audio/wav;base64,${audioData}" type="audio/wav">
                    </audio>
                `;
                msgDiv.appendChild(audioPlayer);
            }
            
            conversation.appendChild(msgDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }
        
        // Socket events
        socket.on('ai-response', (data) => {
            addMessage('user', data.transcription);
            addMessage('ai', data.response, data.audioData);
            status.textContent = 'Bereit f√ºr nat√ºrliche Unterhaltung';
        });
        
        socket.on('error', (data) => {
            showError(data.message);
            status.textContent = 'Bereit f√ºr nat√ºrliche Unterhaltung';
        });
    </script>
</body>
</html>